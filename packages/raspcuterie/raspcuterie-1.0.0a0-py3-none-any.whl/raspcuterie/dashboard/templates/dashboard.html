<!DOCTYPE html>
<html lang="en" class="has-background-danger">
<head>
    <meta charset="UTF-8">
    <title>Raspcuterie v{{ version }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma-switch@2.0.0/dist/css/bulma-switch.min.css"
          integrity="sha256-jCV/cXwP13w0GNHLgFx6SFgTNAvJPvS5MIhuE30Ng08=" crossorigin="anonymous">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://kit.fontawesome.com/3409146a90.js" crossorigin="anonymous"></script>
    <style>
        .panel-block:last-child {
            border-bottom-right-radius: 0 !important;
            border-bottom-left-radius: 6px;
        }

        #menu {
            position: fixed;
            right: 0;
            top: 50%;
            width: 8em;
            margin-top: -2.5em;
            text-align: right;
            z-index: 1;
        }

        #menu button {
            border-radius: 0;
        }

        #menu button:first-child {
            border-top-left-radius: 6px;
        }

        #menu button:last-child {
            border-bottom-left-radius: 6px;
        }

        .linenodiv pre {
            line-height: 1.25;
        }

    </style>
</head>
<body class="has-background-danger">

<div id="app">
    <div id="menu">
        <button class="button" v-on:click="page = 'dashboard' ">
                <span class="icon">
                  <i class="fas fa-tachometer" aria-hidden="true"></i>
                </span>
        </button>
        <br/>
        <button class="button" v-on:click="page = 'settings' ">
                <span class="icon">
                  <i class="fas fa-cogs" aria-hidden="true"></i>
                </span>
        </button>
    </div>
    <section class="section">
        <div class="container">
            <h1 class="title">
                Raspcuterie
            </h1>
            <p class="subtitle">
                Let it <strong>dry</strong>!
            </p>
            <div v-if="page == 'dashboard'">
                <div class="columns">
                    <div class="column">
                        <div class="notification is-white has-text-justified">
                            <div class="level">
                                {% for name, device in output_devices.items() %}
                                    <div class="level-item" title="{{ device.name }}">
                                <span class="fa-stack fa-md">
                                    <i class="fas {{ device.icon }} fa-lg  fa-stack-1x"></i>
                                    <i v-if="{{ device.name }}" class="fas fa-stack-2x fa-check has-text-success"></i>
                                    <i v-else class="fas fa-stack-2x fa-ban has-text-danger"></i>
                                </span>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="columns">
                    <div class="column">
                        <div class="notification is-white">
                            {% for name,chart in charts.items() %}
                                <div id="chart-{{ name }}">
                                    <apexchart type="line" height="230" ref="{{ name }}"
                                               :options="{{ name }}ChartOptions"
                                               :series="{{ name }}Series"></apexchart>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                </div>
                <div class="columns">
                    {% for name,device in input_devices.items() %}
                        <div class="column">
                            <div class="card has-background-info has-text-white mb-5">
                                <div class="is-overlay is-flex modal-background is-align-content-end is-justify-content-flex-end"
                                     v-if="{{ name }}.humidity.loading" style="background-color: rgba(10,10,10,.36);">
                                    <div class="fa-1x mr-3 mt-3">
                                        <i class="fas fa- fa-sync fa-spin"></i>
                                    </div>
                                </div>
                                <div class="card-content">
                                    <div class="media">
                                        <div class="media-left">
                                            {{ name }} <br/>
                                            <i class="far fa-humidity fa-4x"></i>
                                            <i class="far fa-long-arrow-alt-down fa-4x"
                                               v-if="{{ name }}.humidity.slope < 0"></i>
                                            <i class="far fa-long-arrow-alt-up fa-4x" v-else></i>
                                        </div>
                                        <div class="media-content ">
                                            <p class="title is-4 has-text-white">
                                                {{ '{{' }} {{ name }}.humidity.current {{ '}}' }}&deg;
                                            </p>
                                            <p class="subtitle is-6 has-text-white">
                                                <i class="far fa-arrow-to-top mr-2"></i>
                                                {{ '{{' }} {{ name }}.humidity.max {{ '}}' }} <br/>
                                                <i class="far fa-arrow-to-bottom  mr-2"></i>
                                                {{ '{{' }} {{ name }}.humidity.min {{ '}}' }} <br/>
                                                <i class="far fa-tachometer-average  mr-2"></i>
                                                {{ '{{' }} {{ name }}.humidity.avg {{ '}}' }} <br/>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card has-background-primary has-text-white mb-5">
                                <div class="is-overlay is-flex is-align-content-end	is-justify-content-flex-end"
                                     v-if="{{ name }}.temperature.loading"
                                     style="background-color: rgba(10,10,10,.36);">
                                    <div class="fa-1x mr-3 mt-3">
                                        <i class="fas fa- fa-sync fa-spin"></i>
                                    </div>
                                </div>
                                <div class="card-content">
                                    <div class="media">
                                        <div class="media-left">
                                            {{ name }} <br/>
                                            <i class="far fa-temperature-down fa-4x"
                                               v-if="{{ name }}.temperature.slope < 0"></i>
                                            <i class="far fa-temperature-up fa-4x" v-else></i>
                                        </div>
                                        <div class="media-content ">
                                            <p class="title is-4 has-text-white">
                                                {{ '{{' }} {{ name }}.temperature.current {{ '}}' }}&deg;
                                            </p>
                                            <p class="subtitle is-6 has-text-white">
                                                <i class="far fa-thermometer-three-quarters mr-2"></i>
                                                {{ '{{' }} {{ name }}.temperature.max {{ '}}' }} <br/>
                                                <i class="far fa-thermometer-empty  mr-2"></i>
                                                {{ '{{' }} {{ name }}.temperature.min {{ '}}' }} <br/>
                                                <i class="far fa-tachometer-average  mr-2"></i>
                                                {{ '{{' }} {{ name }}.temperature.avg {{ '}}' }} <br/>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {{ '{{' }} {{ name }}.lastRequestTime {{ '}}' }}
                        </div>
                    {% endfor %}
                </div>
            </div>
            <div class="tile is-ancestor" v-else>
                <div class="tile is-vertical">
                    <div class="tile">
                        <div class="tile is-parent">
                            <article class="tile is-child notification is-white">
                                <div class="field">
                                    <label class="label">Period, since</label>
                                    <div class="control">
                                        <div class="select">
                                            <select v-model="period">
                                                <option value="-1 hours">Last hour</option>
                                                <option value="-2 hours">Last 2 hour</option>
                                                <option value="-3 hours">Last 3 hour</option>
                                                <option value="-6 hours">Last 6 hour</option>
                                                <option value="-9 hours">Last 9 hour</option>
                                                <option value="-12 hours">Last 12 hours</option>
                                                <option value="-24 hours">Last day</option>
                                                <option value="-7 days">Last week</option>
                                                <option value="-14 days">Last 4 weeks</option>
                                                <option value="-28 days">Last 8 weeks</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="field">
                                    <label class="label">Password</label>
                                    <div class="control">
                                        <input v-model="password" class="input" type="password" placeholder="Password">
                                    </div>
                                </div>
                            </article>
                        </div>
                        <div class="tile is-parent">
                            <article class="tile is-child notification is-white">
                                <label class="label">Aggregate data by</label>
                                <div class="control">
                                    <div class="select">
                                        <select v-model="aggregate">
                                            <option value="60">1 minute</option>
                                            <option value="300">5 minutes</option>
                                            <option value="600">10 minutes</option>
                                            <option value="900">15 minutes</option>
                                            <option value="3600">Hour</option>
                                            <option value="86400">Day</option>
                                        </select>
                                    </div>
                                </div>
                            </article>
                        </div>
                        <div class="tile is-parent">
                            <article class="tile is-child notification is-warning">
                                {% for name, device in output_devices.items() %}
                                    <div class="field">
                                        <input id="{{ name }}-switch" type="checkbox"
                                               class="switch is-danger"
                                               checked="checked" v-model="{{ name }}"
                                               @change="toggle{{ name|title }}()">
                                        <label for="{{ name }}-switch">{{ name }}</label>
                                    </div>
                                {% endfor %}
                            </article>
                        </div>
                    </div>
                    <div class="tile">
                        <div class="tile is-parent">
                            <div class="tile is-child notification is-white">
                                <h1 class="h1">Config</h1>
                                <div v-html="configHtml"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </section>
</div>


<script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.js"
        integrity="sha256-FZ8KwMj1F6qnNgA7bhPryVm19xKduH5OVr8u7I1tAtc=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts@3.22.0/dist/apexcharts.js"
        integrity="sha256-4Lasz800h6YPi4MMNryQ1EUqRsW+PBE8g2pus4sK5Nw=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/vue-apexcharts@1.6.0/dist/vue-apexcharts.js"
        integrity="sha256-uFIs+Z5USR6iT5utTt+Hx6Du05iEURM/uwwfVsUUvxc=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/axios@0.20.0/dist/axios.js"
        integrity="sha256-n7FNwoYsyZMMiu5/NHArDRUq4JFdaZNPz8mE+OMC5VM=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bulma-extensions@6.2.7/dist/js/bulma-extensions.min.js"
        integrity="sha256-q4zsxO0fpPm6VhtL/9QkCFE5ZkNa0yeUxhmt1VO1ev0=" crossorigin="anonymous"></script>
<script type="text/javascript">

    new Vue({
        el: '#app',
        components: {
            apexchart: VueApexCharts,
        },
        data() {
            return {
                configHtml: "",
                password: "",
                page: "dashboard",
                period: "-24 hours",
                aggregate: 300,
                {% for name, json in charts_json.items() %}
                    "{{ name }}ChartOptions": {{ json|safe }},
                    "{{ name }}Series": [],
                {% endfor %}
                {% for name, device in output_devices.items() %}
                    "{{ name }}": false,
                {% endfor %}
                {% for name, device in input_devices.items() %}
                    "{{ name }}": {
                        temperature: {
                            current: 0,
                            min: 0,
                            max: 0,
                            avg: 0,
                            slope: 1,
                            loading: true,
                        },
                        lastRequestTime: "n/a",
                        humidity: {
                            current: 0,
                            min: 0,
                            max: 0,
                            avg: 0,
                            slope: 1,
                            loading: true,
                        },
                    },
                {% endfor %}
            }
        },
        methods: {
            {% for name, device in output_devices.items() %}
                toggle{{ name|title }}: function () {
                    axios({
                        method: 'GET',
                        url: "/api/relay/{{ name }}/toggle",
                        params: {password: this.password}
                    }).then(response => {
                        this.{{ name }} = response.data["state"]
                    })
                }
                ,
            {% endfor %}
            updateChartInterval() {
                setInterval(() => {
                    {% for name, chart in charts.items() %}
                        this.update{{ name|title }}Chart()
                    {% endfor %}
                    {% for name, device in input_devices.items() %}
                        this.update{{ name|title }}Device()
                    {% endfor %}
                    this.updateRelayValues()
                }, 1000 * 60);

                {% for name, chart in charts.items() %}
                    this.update{{ name|title }}Chart()
                {% endfor %}
                {% for name, device in input_devices.items() %}
                    this.update{{ name|title }}Device()
                {% endfor %}
            },
            updateRelayValues() {
                axios({
                    method: 'GET',
                    url: "/api/relay/current.json",
                }).then(response => {
                    {% for name, device in output_devices.items() %}
                        this.{{ name }} = response.data["{{ name }}"]
                    {% endfor %}
                });
            },
            {% for name, chart in charts.items() %}
                update{{ name|title }}Chart() {
                    axios({
                        method: 'GET',
                        url: "/api/chart/{{ name }}/series.json",
                        params: {
                            period: this.period,
                            aggregate: this.aggregate,
                        }
                    }).then(response => {
                        this.{{ name }}Series = response.data
                    });
                },
            {% endfor %}
// @formatter:off
            {% for name,device in input_devices.items() %}
                update{{name|title}}Device() {
                    this.{{ name }}.humidity.loading = true
                    this.{{ name }}.temperature.loading = true

                    axios({
                        method: 'GET',
                        url: "/api/devices/{{ name }}/current.json",
                        params: {
                            period: this.period,
                            aggregate: this.aggregate,
                        }
                    }).then(response => {
                        this.{{ name }}.humidity = response.data["humidity"]
                        this.{{ name }}.temperature = response.data["temperature"]
                        this.{{ name }}.lastRequestTime = response.data["time"]

                        this.{{ name }}.humidity.loading = false
                        this.{{ name }}.temperature.loading = false
                    });
                },
            {% endfor %}
        // @formatter:on
            loadLocalStorage() {
                if (localStorage.period) {
                    this.period = localStorage.period
                }

                if (localStorage.aggregate) {
                    this.aggregate = localStorage.aggregate
                }
            }
        },
        mounted: function () {
            this.loadLocalStorage()
            this.updateRelayValues()
            this.updateChartInterval()

            let self = this
            axios.get('/api/config.html').then(function (response) {
                self.configHtml = response.data
                console.log(self.configHtml)
            });
        },
        watch: {
            period(value) {
                localStorage.period = value;
            }
            ,
            aggregate(value) {
                localStorage.aggregate = value;
            }
        }
    });


</script>

</body>
</html>
