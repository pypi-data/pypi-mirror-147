{% extends 'timeseer.html' %}
{% from 'flows.html' import flows_header with context %}
{% from 'macros.html' import bootstrap_icon, info_popover, menu_back, visualize_score %}

{% macro compare(a, b) %}
<td>
    {% if a == b %}
    <span>=</span>
    {% elif a > b %}
    <span class="text-danger">{{ b - a }}%</span>
    {% else %}
    <span class="text-success">+{{ b - a }}%</span>
    {% endif %}
</td>
{% endmacro %}

{% block styles %}
<style>
    .comparison-table {
        table-layout: fixed;
    }
    .comparison-table .score {
        width: 25%;
    }
    .comparison-table .evolution {
        width: 15%;
    }
</style>
{% endblock %}

{% block menu %}
{{ menu_back(url_for('.list_reports', sourcename=source_name, blockevaluationid=block_evaluation.db_id)) }}
{% endblock %}

{% block main %}
{{ flows_header(block_evaluation.flow_evaluation, 'Compare reports') }}

<div class="pt-3 my-3">
    <p>
        Comparing reports from
        <a href="{{ url_for('.open_report', blockevaluationid=compare_evaluation.db_id, sourcename=source_name) }}" target="_blank">
            {{ comparison.date|datetimeformat }}
            <sup>{{ bootstrap_icon('box-arrow-up-right') }}</sup>
        </a>
        and
        <a href="{{ url_for('.open_report', blockevaluationid=block_evaluation.db_id, sourcename=source_name) }}" target="_blank">
            {{ report.date|datetimeformat }}
            <sup>{{ bootstrap_icon('box-arrow-up-right') }}</sup>
        </a>
        .
    </p>

    <table class="ts-table table table-borderless comparison-table">
        <thead class="thead-secondary">
            <tr class="border-top border-bottom">
                <th scope="col">Score</th>
                <th scope="col" class="score">{{ comparison.date|datetimeformat }}</th>
                <th scope="col" class="score">{{ report.date|datetimeformat }}</th>
                <th scope="col" class="evolution">Evolution</th>
            </tr>
        </thead>
        <tbody>
            <tr class="border-bottom">
                <th scope="row" class="fw-normal">Aggregated score</th>
                {{ visualize_score(comparison.score) }}
                {{ visualize_score(report.score) }}
                {{ compare(comparison.score, report.score) }}
            </tr>
        </tbody>
    </table>

    <table class="ts-table table table-borderless comparison-table">
        <thead class="thead-secondary">
            <tr class="border-top border-bottom">
                <th scope="col">KPI</th>
                <th scope="col" class="score">{{ comparison.date|datetimeformat }}</th>
                <th scope="col" class="score">{{ report.date|datetimeformat }}</th>
                <th scope="col" class="evolution">Evolution</th>
            </tr>
        </thead>
        <tbody>
            {% for kpi in entries|map(attribute='kpi') %}
            <tr class="border-bottom">
                <th scope="row" class="fw-normal">
                    {{ kpi.name }}
                    {% if kpi.short_help_text %}
                    {{ info_popover(kpi.short_help_text) }}
                    {% endif %}
                </th>
                {% if kpi in comparison.kpi_scores %}
                {{ visualize_score(comparison.kpi_scores[kpi]) }}
                {% else %}
                <td>-</td>
                {% endif %}
                {% if kpi in report.kpi_scores %}
                {{ visualize_score(report.kpi_scores[kpi]) }}
                {% else %}
                <td>-</td>
                {% endif %}
                {% if kpi in comparison.kpi_scores and kpi in report.kpi_scores %}
                {{ compare(comparison.kpi_scores[kpi], report.kpi_scores[kpi]) }}
                {% else %}
                <td>-</td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% for kpi in entries|map(attribute='kpi') %}
    <table class="ts-table table table-borderless comparison-table">
        <thead class="thead-secondary">
            <tr class="border-top border-bottom">
                <th scope="col">{{ kpi.name }}</th>
                <th scope="col" class="score">{{ comparison.date|datetimeformat }}</th>
                <th scope="col" class="score">{{ report.date|datetimeformat }}</th>
                <th scope="col" class="evolution">Evolution</th>
            </tr>
        </thead>
        <tbody>
            {% for score in report.kpi_score_scores[kpi.name]|sort(attribute='metadata.name') %}
            <tr class="border-bottom">
                <th scope="row" class="fw-normal">
                    {{ score.metadata.name|capitalize }}
                    {% if score.metadata.short_help_text %}
                    {{ info_popover(score.metadata.short_help_text) }}
                    {% endif %}
                </th>
                {% set comparison_scores = comparison.kpi_score_scores[kpi.name]|selectattr('metadata.name', 'eq', score.metadata.name)|list %}
                {% if comparison_scores|count > 0 %}
                {{ visualize_score(comparison_scores|first|attr('score')) }}
                {{ visualize_score(score.score) }}
                {{ compare(comparison_scores|first|attr('score'), score.score) }}
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endfor %}
</div>
{% endblock %}
