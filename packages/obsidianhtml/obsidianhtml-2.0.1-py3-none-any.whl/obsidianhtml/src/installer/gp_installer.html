<!DOCTYPE html>
<html>

<head lang="en">
    <meta charset="UTF-8">
    <style>
		body {
		    margin: 2rem;
		}
		
		h2 {
		    border-bottom: 1px solid #b3c0c8;
		}
		h3 {
		    border-bottom: 5px solid #f5f1ff;
		}        
		
		#footer {
		    margin-top: 4rem;
		    color: gray;
		    border-top: 2px solid #ddd;
		    text-align: center;
		}
		
		code {
		    color: green;
		}
		
		.info-icon {
		    float: right;
		    background-color: #3175f7;
		    width: 1.0rem;
		    height: 1rem;
		    padding: 0.1rem;
		    text-align: center;
		    padding-bottom: 0rem;
		    color: white;
		    font-weight: bold;
		    border-radius: 1rem;
		    line-height: 11pt;
		    cursor: pointer;
		}
		.info-line {
		    width: 100%;
		    background-color: whitesmoke;
		    padding: 1rem;
		    margin: 1rem;
		    margin-left: -1rem;
		    font-size: 10pt;
		}
		
		.optional {
		    margin: 1rem;
		    border: 1px dotted #375fd4;
		    padding: 1rem;
		    background-color: #e6efff;
		}
		
		.annotation {
		    margin: 0.3rem;
		    padding: 0.3rem;
		}
		  
		label {
		    margin-left: 0.3rem;
		    margin-right: 0.3rem;
		}
		
		.hide {
		    display: none
		}
		
		.spacer-1 {
		    margin: 0rem;
		    padding:0rem;
		}
		.spacer-2 {
		    margin: 0rem;
		    padding:0rem;
		}
		.spacer-3 {
		    margin: 0rem;
		    padding:0rem;
		}
		.spacer-4 {
		    margin: 0rem;
		    padding:0rem;
		}
		.flex-row {
		    display: flex;
		    flex-direction: row;
		    margin-bottom: 0.5rem;
		}
		.flex-row>.annotation {
		    flex: 4;
		}
		.flex-row>div.label {
		    flex: 1;
		}
		.flex-row>.spacer-1 {
		    flex: 1;
		}  
		.flex-row>.spacer-2 {
		    flex: 2;
		}  
		.flex-row>.spacer-3 {
		    flex: 3;
		}  
		.flex-row>.spacer-4 {
		    flex: 4;
		}                                
		.flex-row>input {
		    flex: auto;
		}        
		.flex-row>button {
		    flex: 1;
		} 
		#pywebview-status {
		    position: absolute;
		    top: 0rem;
		    right: 1rem;
		}
		
		#response-container {
		    display: none;
		    padding: 3rem;
		    margin: 3rem 5rem;
		    font-size: 12pt;
		    border: 5px dashed #ccc;
		}
		
		.code-0 {
		    color: gray
		}
		
		.code-405 {
		    color: rgb(237, 10, 10);
		
		}
		
		.code-500 {
		    color: rgb(237, 10, 10);
		    font-weight: bold;
		}
		
		.code-500::before {
		    content: 'Internal Error: ';
		}
		
		.blink_me {
		    animation: blinker 1s linear infinite;
		}
		
		@keyframes blinker {
		    50% {
		        opacity: 0;
		        color: rgb(237, 10, 10);
		    }
		}
		
		.done {
		    background-color: #e9ffdf;
		    color: #14440a;
		    border: 1px dotted #248a07;
		}
		.action-link {
		    color: blue;
		    text-decoration: underline;
		    cursor: pointer;
		}
		
		button {
		    font-size: 10pt;
		    margin: 0.3rem;
		    background-color: #0a365d;
		    border: 0px solid #fff;
		    color: white;
		    font-weight: normal;
		    border-radius: 0.4rem;
		    cursor: pointer;
		}
		.bottom {
		    margin-left: -2rem;
		    width: calc(100vw);
		    position: fixed;
		    bottom: -0.3rem;
		    border-top: 1px solid #9090a4;
		}    
		
		#footer button {
		    padding: 1rem;
		    display: block;
		    width: 100%;
		    border-radius: 0;
		    padding-top: 0.3rem;
		    padding-bottom: 0.3rem;
		    background-color: #c8c8d9;
		    color: #191d59;
		}
		#footer button.bottom {
		    padding: 0.5rem;
		}
		
		#footer button.done {
		    background-color: #e0eeb9;
		    color: #14440a;
		}
		div.done button {
		    background-color: #bae5ab;
		    color: #14440a;
		}
		
		

	</style>
    <script>
        let WINDOW_ID = 'self'
    </script>
</head>

<body>

    <p id='pywebview-status'><span class="blink_me">Initializing...</span></p>

    <h1>GithubPages Installer</h1>
    <p>This installer will configure an action for publishing your vault directly to a <a
            href="https://pages.github.com/">github page</a>.</p>
    <p>This setup needs to be done once, after that, you can publish again by running
        <br /><code>obsidianhtml --publish githubpages</code> from the terminal.
    </p>

    <h2>Set inputs</h2>

    <input id="select-vault-path" />


    <div class="flex-row">
        <button onClick="api('getEntrypointPath', {}, 'annotation-entrypoint-path')">Select entrypoint
            note</button><br />
        <div class="annotation" id="annotation-entrypoint-path">None selected</div>
        <div class="info-icon" onClick="toggle('info-1')">i</div>
    </div>
    <div class="info-line" id="info-1" style="display: none;">
        In default mode, ObsidianHtml will start compiling your website starting with this node, and following any links to any other note.
        This note has to be in the vault selected above.
    </div>    

    <h2>Set gitpages repo</h2>
    <div>
        <input type="radio" id="huey" name="drone" value="huey"
            onclick="choose_optional_setup_gitpages('set-up-git','select-git-repo')" checked>
        <label for="huey">Help me with setting up the gitpages repo</label>
    </div>
    <div>
        <input type="radio" id="dewey" name="drone" value="dewey"
            onclick="choose_optional_setup_gitpages('select-git-repo','set-up-git')">
        <label for="dewey">I have already set up a gitpages repo and cloned it locally</label>
    </div>

    <div id="set-up-git" class="optional">
        <div class="flex-row">
            <button onClick="api('OpenWindowSetupGitpage', {}, 'annotation-setup-repo')">Set up gitpages</button><br />
            <div class="annotation" id="annotation-setup-repo">&nbsp;</div>
        </div>
    </div>

    <div id="select-git-repo" class="optional" style="display: none;">
        <div class="flex-row">
            <button onClick="api('getRepoPath', {}, 'annotation-repo-path')">Select gitpages repo folder</button><br />
            <div class="annotation" id="annotation-repo-path">None selected.</div>
        </div>
    </div>

    <div id="response-container"></div>

    <!--    ---------------------------------------------------------------------- -->

    <div id="footer" style="border: none;">
        <button class="action bottom" id="exit-button" onClick="close_window()">Close</button>
    </div>

    <script>
		// HTML Functions
		// -----------------------------------------------------------------------
		function toggle(id) {
		    let cont = document.getElementById(id)
		    if (cont.style.display == 'none') {
		        cont.style.display = 'block'
		    } else {
		        cont.style.display = 'none'
		    }
		}
		
		function set_form_status(done) {
		    let el = document.getElementById("exit-button")
		    if (el) {
		        if (done) {
		            el.classList.add("done");
		        } else {
		            el.classList.remove("done");
		        }
		    }
		}
		
		function span_wrap(msg, code) {
		    return '<span class="code-' + code + '">' + msg + '</span>'
		}
		
		// API
		// -----------------------------------------------------------------------
		function api(method, args, resultdiv_id) {
		    action = showResponseEnclosure(resultdiv_id)
		    pywebview.api.call(method, args).then(action).catch(action)
		}
		function showResponseEnclosure(resultdiv_id) {
		    return function(response) {
		        showResponse(response, resultdiv_id)
		    }
		}
		function showResponse(args) {
		    //alert(args)
		    var container = document.getElementById(args.result_div_id)
		
		    if (args.code == null){
		        code = 500
		    } else {
		        code = args.code
		    }
		    container.innerHTML = '<span class="code-' + code + '">' + args.message + '</span>'
		    container.style.display = 'block'
		}


        // Intervals
        // -----------------------------------------------------------------------
        let CheckGitpagesSetupDone_IntervId;

        // On load
        // -----------------------------------------------------------------------
        window.addEventListener('pywebviewready', function () {
            var container = document.getElementById('pywebview-status')
            container.innerHTML = '<span style="color:green">GUI initialized</span>'

            // presets
            pywebview.api.read_ledger({
                'ids': ['vault_path', 'entrypoint_path', 'config_folder_path'],
                'div_ids': ['annotation-vault-path', 'annotation-entrypoint-path', 'annotation-config-path']
            }).then(setValuesOutput).catch(setValuesOutput)

            StartCheck_gitlab_setup_done()
        })

        // Page specific
        // -----------------------------------------------------------------------       
        function close_window(){
            clearInterval(CheckGitpagesSetupDone_IntervId);
            api('close', {'window_id': WINDOW_ID}, 'outnull')
        }
        function StartCheck_gitlab_setup_done(){
            check = function(){
                let action = function(response){
                    if (response.data == true){
                        document.getElementById('annotation-setup-repo').innerHTML = response.message
                        document.getElementById('set-up-git').classList.add('done')
                    }
                }
                pywebview.api.check_gitpages_configured().then(action).catch(action)
            }
            CheckGitpagesSetupDone_IntervId = setInterval(check, 500);
        }

        function setValuesOutput(response) {
            document.getElementById(response.data[response.ids[0]].div_id).innerHTML = span_wrap('error while preloading data. ' + response.message, 500);

            for (let i = 0; i < response.ids.length; i++) {

                let id = response.ids[i]

                let container = document.getElementById(response.data[id].div_id)

                let val = response.data[id].value
                if (val == '') {
                    val = span_wrap('Not configured', 0)
                }
                container.innerHTML = val
            }
        }

        function choose_optional_setup_gitpages(enable, disable) {
            document.getElementById(enable).style.display = 'block';
            document.getElementById(disable).style.display = 'none';
        }
    </script>
</body>

</html>